---
ADMIN USERNAME: azureuser
APP CONTAINER: 'f5devcentral/f5-demo-app:latest'
ARTIFACT LOCATION: 'templates/'
AUTOFILL BIGIQ LICENSE KEY: ''
AUTOFILL CLPV2 LICENSE KEY: ''
BIGIQ ADDRESS: <RESOURCE GROUP>-bigiq.<REGION>.cloudapp.azure.com
BIGIQ TENANT: myTenant
CMD: >-
  mkdir -p /config/cloud; mkdir -p /var/log/cloud/azure; echo -e '{\"extension_packages\":{\"install_operations\":[{\"extensionType\":\"do\",\"extensionVersion\":\"1.17.0\"},{\"extensionType\":\"as3\",\"extensionVersion\":\"3.26.0\"},{\"extensionType\":\"ts\",\"extensionVersion\":\"1.16.0\"}]},\"extension_services\":{\"service_operations\":[{\"extensionType\":\"as3\",\"type\":\"inline\",\"value\":{\"schemaVersion\":\"3.0.0\",\"class\":\"ADC\",\"remark\":\"Autoscale\",\"label\":\"Autoscale\",\"Tenant_1\":{\"class\":\"Tenant\",\"Shared\":{\"class\":\"Application\",\"template\":\"shared\",\"telemetry_local_rule\":{\"remark\":\"Only required when TS is a local listener\",\"class\":\"iRule\",\"iRule\":\"when CLIENT_ACCEPTED {\\n  node 127.0.0.1 6514\\n}\"},\"telemetry_local\":{\"remark\":\"Only required when TS is a local listener\",\"class\":\"Service_TCP\",\"virtualAddresses\":[\"255.255.255.254\"],\"virtualPort\":6514,\"iRules\":[\"telemetry_local_rule\"]},\"telemetry\":{\"class\":\"Pool\",\"members\":[{\"enable\":true,\"serverAddresses\":[\"255.255.255.254\"],\"servicePort\":6514}],\"monitors\":[{\"bigip\":\"\/Common\/tcp\"}]},\"telemetry_hsl\":{\"class\":\"Log_Destination\",\"type\":\"remote-high-speed-log\",\"protocol\":\"tcp\",\"pool\":{\"use\":\"telemetry\"}},\"telemetry_formatted\":{\"class\":\"Log_Destination\",\"type\":\"splunk\",\"forwardTo\":{\"use\":\"telemetry_hsl\"}},\"telemetry_publisher\":{\"class\":\"Log_Publisher\",\"destinations\":[{\"use\":\"telemetry_formatted\"}]},\"telemetry_traffic_log_profile\":{\"class\":\"Traffic_Log_Profile\",\"requestSettings\":{\"requestEnabled\":true,\"requestProtocol\":\"mds-tcp\",\"requestPool\":{\"use\":\"telemetry\"},\"requestTemplate\":\"event_source=\\\"request_logging\\\",hostname=\\\"$BIGIP_HOSTNAME\\\",client_ip=\\\"$CLIENT_IP\\\",server_ip=\\\"$SERVER_IP\\\",http_method=\\\"$HTTP_METHOD\\\",http_uri=\\\"$HTTP_URI\\\",virtual_name=\\\"$VIRTUAL_NAME\\\",event_timestamp=\\\"$DATE_HTTP\\\"\"},\"responseSettings\":{\"responseEnabled\":true,\"responseProtocol\":\"mds-tcp\",\"responsePool\":{\"use\":\"telemetry\"},\"responseTemplate\":\"event_source=\\\"response_logging\\\",hostname=\\\"$BIGIP_HOSTNAME\\\",client_ip=\\\"$CLIENT_IP\\\",server_ip=\\\"$SERVER_IP\\\",http_method=\\\"$HTTP_METHOD\\\",http_uri=\\\"$HTTP_URI\\\",virtual_name=\\\"$VIRTUAL_NAME\\\",event_timestamp=\\\"$DATE_HTTP\\\",http_statcode=\\\"$HTTP_STATCODE\\\",http_status=\\\"$HTTP_STATUS\\\",response_ms=\\\"$RESPONSE_MSECS\\\"\"}},\"telemetry_asm_security_log_profile\":{\"class\":\"Security_Log_Profile\",\"application\":{\"localStorage\":false,\"remoteStorage\":\"splunk\",\"servers\":[{\"address\":\"255.255.255.254\",\"port\":\"6514\"}],\"storageFilter\":{\"requestType\":\"all\"}}},\"shared_pool\":{\"class\":\"Pool\",\"remark\":\"Service 1 shared pool\",\"members\":[{\"addressDiscovery\":\"azure\",\"addressRealm\":\"private\",\"resourceGroup\":\"{{{RESOURCE_GROUP_NAME}}}\",\"resourceId\":\"{{{UNIQUE_STRING}}}-app-vmss\",\"resourceType\":\"scaleSet\",\"servicePort\":80,\"subscriptionId\":\"{{{SUBSCRIPTION_ID}}}\",\"updateInterval\":60,\"useManagedIdentity\":true}],\"monitors\":[\"http\"]}},\"HTTP_Service\":{\"class\":\"Application\",\"template\":\"http\",\"serviceMain\":{\"class\":\"Service_HTTP\",\"virtualAddresses\":[\"0.0.0.0\"],\"policyWAF\":{\"use\":\"WAFPolicy\"},\"pool\":\"\/Tenant_1\/Shared\/shared_pool\",\"securityLogProfiles\":[{\"use\":\"\/Tenant_1\/Shared\/telemetry_asm_security_log_profile\"}]},\"WAFPolicy\":{\"class\":\"WAF_Policy\",\"url\":\"https:\/\/raw.githubusercontent.com\/F5Networks\/f5-azure-arm-templates-v2\/master\/examples\/autoscale\/bigip-configurations\/Rapid_Depolyment_Policy_13_1.xml\",\"enforcementMode\":\"transparent\",\"ignoreChanges\":false}},\"HTTPS_Service\":{\"class\":\"Application\",\"template\":\"https\",\"serviceMain\":{\"class\":\"Service_HTTPS\",\"virtualAddresses\":[\"0.0.0.0\"],\"policyWAF\":{\"use\":\"WAFPolicy\"},\"pool\":\"\/Tenant_1\/Shared\/shared_pool\",\"securityLogProfiles\":[{\"use\":\"\/Tenant_1\/Shared\/telemetry_asm_security_log_profile\"}],\"serverTLS\":{\"bigip\":\"\/Common\/clientssl\"},\"redirect80\":false},\"WAFPolicy\":{\"class\":\"WAF_Policy\",\"url\":\"https:\/\/raw.githubusercontent.com\/F5Networks\/f5-azure-arm-templates-v2\/master\/examples\/autoscale\/bigip-configurations\/Rapid_Depolyment_Policy_13_1.xml\",\"enforcementMode\":\"transparent\",\"ignoreChanges\":false}}}}}]},\"post_onboard_enabled\":[],\"pre_onboard_enabled\":[],\"runtime_parameters\":[{\"name\":\"HOST_NAME\",\"type\":\"metadata\",\"metadataProvider\":{\"type\":\"compute\",\"environment\":\"azure\",\"field\":\"name\"}},{\"name\":\"RESOURCE_GROUP_NAME\",\"type\":\"url\",\"value\":\"http:\/\/169.254.169.254\/metadata\/instance\/compute?api-version=2020-09-01\",\"query\":\"resourceGroupName\",\"headers\":[{\"name\":\"Metadata\",\"value\":true}]},{\"name\":\"UNIQUE_STRING\",\"type\":\"url\",\"value\":\"http:\/\/169.254.169.254\/metadata\/instance\/compute\/tagsList?api-version=2020-09-01\",\"query\":\"[?name==`uniqueString`].value|[0]\",\"headers\":[{\"name\":\"Metadata\",\"value\":true}]},{\"name\":\"WORKSPACE_ID\",\"type\":\"url\",\"value\":\"http:\/\/169.254.169.254\/metadata\/instance\/compute\/tagsList?api-version=2020-09-01\",\"query\":\"[?name==`workspaceId`].value|[0]\",\"headers\":[{\"name\":\"Metadata\",\"value\":true}]},{\"name\":\"SUBSCRIPTION_ID\",\"type\":\"url\",\"value\":\"http:\/\/169.254.169.254\/metadata\/instance\/compute?api-version=2020-09-01\",\"query\":\"subscriptionId\",\"headers\":[{\"name\":\"Metadata\",\"value\":true}]},{\"name\":\"AZURE_PASSWORD\",\"type\":\"secret\",\"secretProvider\":{\"type\":\"KeyVault\",\"environment\":\"azure\",\"vaultUrl\":\"https:\/\/<RESOURCE GROUP>sv.vault.azure.net\",\"secretId\":\"mySecret\"}}]}' > /config/cloud/onboard_config.yaml; f5-bigip-runtime-init -c /config/cloud/onboard_config.yaml 2>&1
DISAGGREGATOR: LB
IMAGE: f5-networks:f5-big-ip-byol:f5-big-all-2slot-byol:16.0.101000
LICENSE TYPE: bigiq
PROVISION PUBLIC IP: true
REGION: westus
RESOURCE GROUP: dd-auto-<DEWPOINT JOB ID>
RESTRICTED SRC ADDRESS: '*'
RUNTIME CONFIG: >-
  {\"extension_packages\":{\"install_operations\":[{\"extensionType\":\"do\",\"extensionVersion\":\"1.17.0\"},{\"extensionType\":\"as3\",\"extensionVersion\":\"3.26.0\"},{\"extensionType\":\"ts\",\"extensionVersion\":\"1.16.0\"}]},\"extension_services\":{\"service_operations\":[{\"extensionType\":\"do\",\"type\":\"inline\",\"value\":{\"Common\":{\"class\":\"Tenant\",\"admin\":{\"class\":\"User\",\"userType\":\"regular\",\"password\":\"{{{AZURE_PASSWORD}}}\",\"shell\":\"bash\"},\"dbvars\":{\"class\":\"DbVariables\",\"provision.extramb\":500,\"restjavad.useextramb\":true},\"myDns\":{\"class\":\"DNS\",\"nameServers\":[\"8.8.8.8\"]},\"myLicense\":{\"class\":\"License\",\"licenseType\":\"licensePool\",\"bigIqHost\":\"<BIGIQ ADDRESS>\",\"bigIqUsername\":\"azureuser\",\"bigIqPassword\":\"{{{AZURE_PASSWORD}}}\",\"licensePool\":\"clpv2\",\"tenant\":\"myTenant\",\"skuKeyword1\":\"F5-BIG-MSP-BT-1G\",\"unitOfMeasure\":\"hourly\",\"reachable\":false,\"hypervisor\":\"azure\",\"overwrite\":false},\"myNtp\":{\"class\":\"NTP\",\"servers\":[\"0.pool.ntp.org\"],\"timezone\":\"UTC\"},\"myProvisioning\":{\"asm\":\"nominal\",\"class\":\"Provision\",\"ltm\":\"nominal\"},\"mySystem\":{\"autoPhonehome\":false,\"class\":\"System\",\"hostname\":\"{{HOST_NAME}}.local\"}},\"async\":true,\"class\":\"Device\",\"label\":\"myBIG-IPdeclarationfordeclarativeonboarding\",\"schemaVersion\":\"1.0.0\"}},{\"extensionType\":\"as3\",\"type\":\"inline\",\"value\":{\"schemaVersion\":\"3.0.0\",\"class\":\"ADC\",\"remark\":\"Autoscale\",\"label\":\"Autoscale\",\"Tenant_1\":{\"class\":\"Tenant\",\"Shared\":{\"class\":\"Application\",\"template\":\"shared\",\"telemetry_local_rule\":{\"remark\":\"Only required when TS is a local listener\",\"class\":\"iRule\",\"iRule\":\"when CLIENT_ACCEPTED {\\n  node 127.0.0.1 6514\\n}\"},\"telemetry_local\":{\"remark\":\"Only required when TS is a local listener\",\"class\":\"Service_TCP\",\"virtualAddresses\":[\"255.255.255.254\"],\"virtualPort\":6514,\"iRules\":[\"telemetry_local_rule\"]},\"telemetry\":{\"class\":\"Pool\",\"members\":[{\"enable\":true,\"serverAddresses\":[\"255.255.255.254\"],\"servicePort\":6514}],\"monitors\":[{\"bigip\":\"\/Common\/tcp\"}]},\"telemetry_hsl\":{\"class\":\"Log_Destination\",\"type\":\"remote-high-speed-log\",\"protocol\":\"tcp\",\"pool\":{\"use\":\"telemetry\"}},\"telemetry_formatted\":{\"class\":\"Log_Destination\",\"type\":\"splunk\",\"forwardTo\":{\"use\":\"telemetry_hsl\"}},\"telemetry_publisher\":{\"class\":\"Log_Publisher\",\"destinations\":[{\"use\":\"telemetry_formatted\"}]},\"telemetry_traffic_log_profile\":{\"class\":\"Traffic_Log_Profile\",\"requestSettings\":{\"requestEnabled\":true,\"requestProtocol\":\"mds-tcp\",\"requestPool\":{\"use\":\"telemetry\"},\"requestTemplate\":\"event_source=\\\"request_logging\\\",hostname=\\\"$BIGIP_HOSTNAME\\\",client_ip=\\\"$CLIENT_IP\\\",server_ip=\\\"$SERVER_IP\\\",http_method=\\\"$HTTP_METHOD\\\",http_uri=\\\"$HTTP_URI\\\",virtual_name=\\\"$VIRTUAL_NAME\\\",event_timestamp=\\\"$DATE_HTTP\\\"\"},\"responseSettings\":{\"responseEnabled\":true,\"responseProtocol\":\"mds-tcp\",\"responsePool\":{\"use\":\"telemetry\"},\"responseTemplate\":\"event_source=\\\"response_logging\\\",hostname=\\\"$BIGIP_HOSTNAME\\\",client_ip=\\\"$CLIENT_IP\\\",server_ip=\\\"$SERVER_IP\\\",http_method=\\\"$HTTP_METHOD\\\",http_uri=\\\"$HTTP_URI\\\",virtual_name=\\\"$VIRTUAL_NAME\\\",event_timestamp=\\\"$DATE_HTTP\\\",http_statcode=\\\"$HTTP_STATCODE\\\",http_status=\\\"$HTTP_STATUS\\\",response_ms=\\\"$RESPONSE_MSECS\\\"\"}},\"telemetry_asm_security_log_profile\":{\"class\":\"Security_Log_Profile\",\"application\":{\"localStorage\":false,\"remoteStorage\":\"splunk\",\"servers\":[{\"address\":\"255.255.255.254\",\"port\":\"6514\"}],\"storageFilter\":{\"requestType\":\"all\"}}},\"shared_pool\":{\"class\":\"Pool\",\"remark\":\"Service 1 shared pool\",\"members\":[{\"addressDiscovery\":\"azure\",\"addressRealm\":\"private\",\"resourceGroup\":\"{{{RESOURCE_GROUP_NAME}}}\",\"resourceId\":\"{{{UNIQUE_STRING}}}-app-vmss\",\"resourceType\":\"scaleSet\",\"servicePort\":80,\"subscriptionId\":\"{{{SUBSCRIPTION_ID}}}\",\"updateInterval\":60,\"useManagedIdentity\":true}],\"monitors\":[\"http\"]}},\"HTTP_Service\":{\"class\":\"Application\",\"template\":\"http\",\"serviceMain\":{\"class\":\"Service_HTTP\",\"virtualAddresses\":[\"0.0.0.0\"],\"policyWAF\":{\"use\":\"WAFPolicy\"},\"pool\":\"\/Tenant_1\/Shared\/shared_pool\",\"securityLogProfiles\":[{\"use\":\"\/Tenant_1\/Shared\/telemetry_asm_security_log_profile\"}]},\"WAFPolicy\":{\"class\":\"WAF_Policy\",\"url\":\"https:\/\/raw.githubusercontent.com\/F5Networks\/f5-azure-arm-templates-v2\/master\/examples\/autoscale\/bigip-configurations\/Rapid_Depolyment_Policy_13_1.xml\",\"enforcementMode\":\"blocking\",\"ignoreChanges\":false}},\"HTTPS_Service\":{\"class\":\"Application\",\"template\":\"https\",\"serviceMain\":{\"class\":\"Service_HTTPS\",\"virtualAddresses\":[\"0.0.0.0\"],\"policyWAF\":{\"use\":\"WAFPolicy\"},\"pool\":\"\/Tenant_1\/Shared\/shared_pool\",\"securityLogProfiles\":[{\"use\":\"\/Tenant_1\/Shared\/telemetry_asm_security_log_profile\"}],\"serverTLS\":{\"bigip\":\"\/Common\/clientssl\"},\"redirect80\":false},\"WAFPolicy\":{\"class\":\"WAF_Policy\",\"url\":\"https:\/\/raw.githubusercontent.com\/F5Networks\/f5-azure-arm-templates-v2\/master\/examples\/autoscale\/bigip-configurations\/Rapid_Depolyment_Policy_13_1.xml\",\"enforcementMode\":\"blocking\",\"ignoreChanges\":false}}}}},{\"extensionType\":\"ts\",\"type\":\"inline\",\"value\":{\"My_Listener\":{\"class\":\"Telemetry_Listener\",\"port\":6514},\"My_System\":{\"class\":\"Telemetry_System\",\"systemPoller\":{\"interval\":60}},\"Azure_Consumer\":{\"appInsightsResourceName\":\"{{{UNIQUE_STRING}}}-insights\",\"class\":\"Telemetry_Consumer\",\"maxBatchIntervalMs\":5000,\"maxBatchSize\":250,\"trace\":true,\"type\":\"Azure_Application_Insights\",\"useManagedIdentity\":true},\"Azure_Log_Analytics\":{\"class\":\"Telemetry_Consumer\",\"type\":\"Azure_Log_Analytics\",\"workspaceId\":\"{{{WORKSPACE_ID}}}\",\"useManagedIdentity\":true,\"region\":\"{{{ REGION }}}\"},\"Bigip_Poller\":{\"actions\":[{\"includeData\":{},\"locations\":{\"system\":{\"cpu\":true,\"networkInterfaces\":{\"1.0\":{\"counters.bitsIn\":true}}}}}],\"class\":\"Telemetry_System_Poller\",\"interval\":60},\"class\":\"Telemetry\",\"controls\":{\"class\":\"Controls\",\"debug\":true,\"logLevel\":\"debug\"}}}]},\"post_onboard_enabled\":[],\"pre_onboard_enabled\":[],\"runtime_parameters\":[{\"name\":\"HOST_NAME\",\"type\":\"metadata\",\"metadataProvider\":{\"type\":\"compute\",\"environment\":\"azure\",\"field\":\"name\"}},{\"name\":\"RESOURCE_GROUP_NAME\",\"type\":\"url\",\"value\":\"http:\/\/169.254.169.254\/metadata\/instance\/compute?api-version=2020-09-01\",\"query\":\"resourceGroupName\",\"headers\":[{\"name\":\"Metadata\",\"value\":true}]},{\"name\":\"UNIQUE_STRING\",\"type\":\"url\",\"value\":\"http:\/\/169.254.169.254\/metadata\/instance\/compute\/tagsList?api-version=2020-09-01\",\"query\":\"[?name==`uniqueString`].value|[0]\",\"headers\":[{\"name\":\"Metadata\",\"value\":true}]},{\"name\":\"WORKSPACE_ID\",\"type\":\"url\",\"value\":\"http:\/\/169.254.169.254\/metadata\/instance\/compute\/tagsList?api-version=2020-09-01\",\"query\":\"[?name==`workspaceId`].value|[0]\",\"headers\":[{\"name\":\"Metadata\",\"value\":true}]},{\"name\":\"SUBSCRIPTION_ID\",\"type\":\"url\",\"value\":\"http:\/\/169.254.169.254\/metadata\/instance\/compute?api-version=2020-09-01\",\"query\":\"subscriptionId\",\"headers\":[{\"name\":\"Metadata\",\"value\":true}]},{\"name\":\"AZURE_PASSWORD\",\"type\":\"secret\",\"secretProvider\":{\"type\":\"KeyVault\",\"environment\":\"azure\",\"vaultUrl\":\"https:\/\/<RESOURCE GROUP>sv.vault.azure.net\",\"secretId\":\"mySecret\"}}]}
SCALING MAX: 10
SCALING MIN: 2
SECRET VALUE: 'B!giq2017'
SEQUENCE NUMBER: 1
SUBSCRIPTION ID: d18b486a-112d-4402-add2-7fb1006f943a
TEMPLATE URL: file://$PWD/examples/autoscale/<LICENSE TYPE>/azuredeploy.json
USE AVAILABILITY ZONES: false
